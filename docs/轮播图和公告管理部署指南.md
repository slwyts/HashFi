# 🚀 轮播图和公告管理系统部署指南

## 概述

我们已经在 Admin.vue 中集成了轮播图和公告管理功能,使用 Cloudflare Workers 作为免费后端。

## ✅ 已完成的工作

### 1. 前端组件
- ✅ `/src/components/admin/BannerManagement.vue` - 轮播图管理界面
- ✅ `/src/components/admin/AnnouncementManagement.vue` - 公告管理界面
- ✅ `/src/views/Admin.vue` - 已集成两个新标签页
- ✅ 签名认证功能 (使用钱包签名)

### 2. 后端 API
- ✅ `/cloudflare-worker/src/index.ts` - Cloudflare Workers API
- ✅ 轮播图 CRUD 接口
- ✅ 公告 CRUD 接口
- ✅ 简单的签名验证 (装个样子的那种 😏)

### 3. 数据存储
- ✅ Cloudflare KV (免费 1GB 存储)

## 📋 部署步骤

### 第一步: 部署 Cloudflare Worker

```bash
# 1. 进入 Worker 目录
cd cloudflare-worker

# 2. 安装依赖
npm install

# 3. 登录 Cloudflare (首次部署需要)
npx wrangler login

# 4. 创建 KV 命名空间
npx wrangler kv:namespace create HASHFI_DATA

# 输出示例:
# [[kv_namespaces]]
# binding = "HASHFI_DATA"
# id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# 5. 把上面的 id 复制到 wrangler.toml 文件中
# 编辑 wrangler.toml, 替换这一行:
# id = "你的KV命名空间ID"

# 6. 部署!
npm run deploy
```

部署成功后会显示 Worker URL,类似:
```
https://hashfi-api.your-subdomain.workers.dev
```

### 第二步: 配置前端

```bash
# 1. 回到项目根目录
cd ..

# 2. 创建 .env 文件
cp .env.example .env

# 3. 编辑 .env 文件,填入 Worker URL
VITE_API_URL=https://hashfi-api.your-subdomain.workers.dev
```

### 第三步: 重新构建前端

```bash
# 开发模式
npm run dev

# 或生产构建
npm run build
```

## 🎮 使用说明

### 1. 访问管理员面板

访问你的网站,进入管理员面板 (Admin 页面)

### 2. 进行签名认证

点击右上角的 "签名认证" 按钮,用钱包签名一次。签名会保存在 localStorage,下次不需要重新签名。

> **注意**: 这个签名验证是"装样子"的实现,只检查签名长度 > 10 就通过。如果需要真正的安全验证,需要修改 Worker 的 `isAuthorized` 函数。

### 3. 管理轮播图

- 点击 "轮播图" 标签
- 可以添加、编辑、删除轮播图
- 设置图片 URL、标题、描述、链接等
- 可以调整显示顺序
- 可以启用/禁用

### 4. 管理公告

- 点击 "公告" 标签
- 可以发布、编辑、删除公告
- 设置公告类型 (普通/重要/紧急)
- 可以添加详情链接
- 可以发布/隐藏

## 🔧 前端组件使用轮播图和公告

### 获取轮播图

在 `BannerCarousel.vue` 或其他组件中:

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue';

const API_URL = import.meta.env.VITE_API_URL;
const banners = ref([]);

onMounted(async () => {
  const response = await fetch(`${API_URL}/banners`);
  const data = await response.json();
  // 只显示启用的轮播图
  banners.value = data.banners.filter(b => b.active).sort((a, b) => a.order - b.order);
});
</script>
```

### 获取公告

在 `AnnouncementBanner.vue` 或其他组件中:

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue';

const API_URL = import.meta.env.VITE_API_URL;
const announcements = ref([]);

onMounted(async () => {
  const response = await fetch(`${API_URL}/announcements`);
  const data = await response.json();
  // 只显示启用的公告,按时间倒序
  announcements.value = data.announcements
    .filter(a => a.active)
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
});
</script>
```

## 💡 数据结构

### Banner (轮播图)

```typescript
{
  id: string;              // 自动生成
  title: string;           // 标题
  description: string;     // 描述
  imageUrl: string;        // 图片URL
  link?: string;           // 点击跳转链接 (可选)
  order: number;           // 显示顺序 (0, 1, 2...)
  active: boolean;         // 是否启用
  createdAt: string;       // 创建时间 (ISO格式)
}
```

### Announcement (公告)

```typescript
{
  id: string;              // 自动生成
  title: string;           // 标题
  content: string;         // 内容
  type: 'normal' | 'important' | 'urgent';  // 类型
  link?: string;           // 详情链接 (可选)
  active: boolean;         // 是否发布
  createdAt: string;       // 创建时间 (ISO格式)
}
```

## 🎯 API 端点

| 方法 | 路径 | 说明 | 需要签名 |
|------|------|------|---------|
| GET | `/banners` | 获取所有轮播图 | ❌ |
| POST | `/banners` | 创建轮播图 | ✅ |
| PUT | `/banners/:id` | 更新轮播图 | ✅ |
| DELETE | `/banners/:id` | 删除轮播图 | ✅ |
| GET | `/announcements` | 获取所有公告 | ❌ |
| POST | `/announcements` | 创建公告 | ✅ |
| PUT | `/announcements/:id` | 更新公告 | ✅ |
| DELETE | `/announcements/:id` | 删除公告 | ✅ |

## 🆓 成本说明

### Cloudflare Workers 免费套餐

- ✅ 每天 100,000 次请求
- ✅ 1GB KV 存储
- ✅ 每天 100,000 次 KV 读取
- ✅ 每天 1,000 次 KV 写入

**对于这个项目来说绰绰有余!** 🎉

## 🔒 安全说明

当前实现的签名验证是"装样子"的,只检查签名长度。如果需要真正的安全验证:

1. 修改 `cloudflare-worker/src/index.ts` 中的 `isAuthorized` 函数
2. 实现真正的签名验证逻辑
3. 验证签名者地址是否为管理员地址

示例:

```typescript
import { verifyMessage } from 'viem';

function isAuthorized(request: Request): boolean {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader) return false;
  
  const signature = authHeader.replace('Bearer ', '');
  
  try {
    // 验证签名
    const message = 'HashFi Admin Authentication';
    const address = verifyMessage({
      message,
      signature,
    });
    
    // 检查是否是管理员地址
    const ADMIN_ADDRESS = '0xYourAdminAddress';
    return address.toLowerCase() === ADMIN_ADDRESS.toLowerCase();
  } catch {
    return false;
  }
}
```

## 🐛 故障排除

### 问题: 无法加载轮播图/公告

**解决**: 
1. 检查 `.env` 文件中的 `VITE_API_URL` 是否正确
2. 检查 Worker 是否部署成功
3. 打开浏览器控制台查看网络请求

### 问题: 无法创建/更新/删除

**解决**:
1. 确保已经进行签名认证
2. 检查 localStorage 中是否有 `admin_signature`
3. 检查浏览器控制台的错误信息

### 问题: KV namespace not found

**解决**:
1. 确保已经创建 KV 命名空间
2. 检查 `wrangler.toml` 中的 KV ID 是否正确

## 📝 下一步

1. ✅ 部署 Cloudflare Worker
2. ✅ 配置前端环境变量
3. ✅ 测试轮播图和公告管理
4. 🔄 更新 `BannerCarousel.vue` 从 API 获取数据
5. 🔄 更新 `AnnouncementBanner.vue` 从 API 获取数据
6. 🔄 (可选) 实现真正的签名验证

## 🎉 完成!

现在你有一个完全免费的、可自定义的轮播图和公告管理系统了!
