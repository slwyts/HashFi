# 推荐人绑定流程图

## 📊 当前系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      智能合约 (HashFi.sol)                    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  struct User {                                                │
│    address referrer;              // 推荐人地址               │
│    address[] directReferrals;     // 直推列表                 │
│    uint256 totalStakedAmount;     // 总质押                   │
│  }                                                            │
│                                                               │
│  ┌──────────────────────────────────────────────────┐        │
│  │  function bindReferrer(address _referrer)        │        │
│  │  - 验证：只能绑定一次                               │        │
│  │  - 验证：推荐人必须已质押                           │        │
│  │  - 验证：不能推荐自己                               │        │
│  │  - 执行：绑定推荐关系                               │        │
│  └──────────────────────────────────────────────────┘        │
│                                                               │
│  ┌──────────────────────────────────────────────────┐        │
│  │  function stake(uint256 _amount)                 │        │
│  │  ✅ require(referrer != 0x0, "Must bind first")  │        │
│  │  - 执行质押逻辑                                     │        │
│  │  - 计算推荐奖励                                     │        │
│  └──────────────────────────────────────────────────┘        │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 用户操作流程

### 场景 1: 新用户通过邀请链接注册

```
┌─────────────┐
│  推荐人 A    │
│ 0x1234...   │
└──────┬──────┘
       │
       │ 分享邀请链接
       ├──────────────────────────────────────────┐
       │                                           │
       │  https://hashfi.io?ref=0x1234...        │
       │                                           │
       └──────────────┬────────────────────────────┘
                      │
                      ▼
              ┌───────────────┐
              │   新用户 B     │
              │               │
              └───────┬───────┘
                      │
                      │ 点击链接
                      ▼
              ┌───────────────┐
              │  前端解析URL   │
              │  ref=0x1234   │
              └───────┬───────┘
                      │
                      │ 连接钱包
                      ▼
              ┌───────────────┐
              │  检查绑定状态  │
              └───────┬───────┘
                      │
                      ├─── 已绑定 ──┐
                      │            │
                      │            ▼
                      │     ┌──────────┐
                      │     │ 可以认购  │
                      │     └──────────┘
                      │
                      └─── 未绑定 ──┐
                                   │
                                   ▼
                           ┌───────────────┐
                           │ 显示绑定弹窗   │
                           │ 预填 0x1234   │
                           └───────┬───────┘
                                   │
                           用户确认 │
                                   ▼
                           ┌───────────────┐
                           │ 调用合约       │
                           │ bindReferrer() │
                           └───────┬───────┘
                                   │
                              ┌────┴────┐
                              │         │
                         成功 │    失败 │
                              │         │
                    ┌─────────┘         └─────────┐
                    │                             │
                    ▼                             ▼
            ┌──────────────┐            ┌──────────────┐
            │ 绑定成功！     │            │ 显示错误原因  │
            │ 可以认购       │            │ - 已绑定     │
            └──────────────┘            │ - 不存在     │
                                       │ - 推荐自己   │
                                       └──────────────┘
```

### 场景 2: 用户尝试认购（未绑定推荐人）

```
┌───────────────┐
│  用户点击认购  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 读取用户信息   │
│ getUserInfo()  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 检查 referrer  │
└───────┬───────┘
        │
        ├─────────────────────────────┐
        │                             │
   已绑定                          未绑定
(referrer != 0x0)         (referrer == 0x0)
        │                             │
        ▼                             ▼
┌───────────────┐           ┌──────────────────┐
│ 1. 检查授权    │           │ ⚠️  警告提示      │
│ 2. 执行认购    │           │ "请先绑定推荐人"   │
│ 3. 完成        │           └─────────┬────────┘
└───────────────┘                     │
                                      │ 当前实现
                                      ▼
                           ┌──────────────────┐
                           │ 跳转到 Profile    │
                           │ router.push()     │
                           └─────────┬────────┘
                                     │
                                     ▼
                           ┌──────────────────┐
                           │ ❌ 没有绑定功能！  │
                           │ 用户懵了...       │
                           └──────────────────┘
```

### 场景 3: 改进后的认购流程

```
┌───────────────┐
│  用户点击认购  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 检查推荐人     │
└───────┬───────┘
        │
        ├────────────────────────────┐
        │                            │
   已绑定                         未绑定
        │                            │
        ▼                            ▼
┌───────────────┐         ┌────────────────────┐
│ 继续认购流程   │         │ 显示绑定模态框      │
└───────────────┘         │                    │
                          │ ┌────────────────┐ │
                          │ │ 输入推荐人地址  │ │
                          │ │ 0x...          │ │
                          │ └────────────────┘ │
                          │                    │
                          │ [取消] [确认绑定]   │
                          └─────────┬──────────┘
                                    │
                              用户确认
                                    │
                                    ▼
                          ┌────────────────────┐
                          │ 调用 bindReferrer() │
                          └─────────┬──────────┘
                                    │
                               成功 │
                                    ▼
                          ┌────────────────────┐
                          │ ✅ 绑定成功         │
                          │ 自动继续认购流程    │
                          └────────────────────┘
```

## 🏗️ 数据流向

```
┌────────────────────────────────────────────────────────────┐
│                         前端应用                            │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │
│  │  App.vue    │    │ Profile.vue │    │ Staking.vue │   │
│  │             │    │             │    │             │   │
│  │  - URL参数  │───▶│  - 显示状态 │◀───│  - 检查状态 │   │
│  │  - 路由     │    │  - 绑定功能 │    │  - 认购流程 │   │
│  └─────────────┘    └──────┬──────┘    └──────┬──────┘   │
│                            │                   │           │
└────────────────────────────┼───────────────────┼───────────┘
                             │                   │
                             │    writeContract  │
                             ▼                   ▼
              ┌──────────────────────────────────────┐
              │         Wagmi + Viem                 │
              │  - writeContractAsync()              │
              │  - useReadContract()                 │
              └─────────────┬────────────────────────┘
                            │
                            │ 发送交易
                            ▼
              ┌──────────────────────────────────────┐
              │        MetaMask / Wallet             │
              │  - 用户确认交易                       │
              │  - 签名                              │
              └─────────────┬────────────────────────┘
                            │
                            │ 发送到区块链
                            ▼
              ┌──────────────────────────────────────┐
              │      Sepolia Testnet / Mainnet       │
              │  - 验证交易                          │
              │  - 执行合约                          │
              └─────────────┬────────────────────────┘
                            │
                            │ 事件回调
                            ▼
              ┌──────────────────────────────────────┐
              │         智能合约                      │
              │  ┌──────────────────────────┐        │
              │  │ bindReferrer()           │        │
              │  │  1. 验证条件              │        │
              │  │  2. 更新 users mapping    │        │
              │  │  3. emit ReferrerBound   │        │
              │  └──────────────────────────┘        │
              │                                       │
              │  mapping(address => User) users;     │
              │                                       │
              └───────────────────────────────────────┘
```

## 📝 推荐人验证逻辑

```
用户调用: bindReferrer(0xABCD...)
         │
         ▼
┌────────────────────────────────────────┐
│  合约验证流程                           │
├────────────────────────────────────────┤
│                                         │
│  1️⃣  检查：是否已绑定？                 │
│     users[msg.sender].referrer == 0x0  │
│                                         │
│     ✅ 是 (0x0) → 继续                  │
│     ❌ 否 → revert "Already bound"     │
│                                         │
├────────────────────────────────────────┤
│                                         │
│  2️⃣  检查：推荐人是否存在？              │
│     users[0xABCD].totalStakedAmount > 0│
│                                         │
│     ✅ 是 (已质押) → 继续               │
│     ❌ 否 → revert "Does not exist"    │
│                                         │
├────────────────────────────────────────┤
│                                         │
│  3️⃣  检查：是否推荐自己？                │
│     0xABCD != msg.sender               │
│                                         │
│     ✅ 否 (不同地址) → 继续             │
│     ❌ 是 → revert "Cannot refer self" │
│                                         │
├────────────────────────────────────────┤
│                                         │
│  4️⃣  执行绑定                           │
│     users[msg.sender].referrer = 0xABCD│
│     users[0xABCD].directReferrals.push │
│     emit ReferrerBound                 │
│                                         │
│     ✅ 绑定成功                          │
│                                         │
└────────────────────────────────────────┘
```

## 🎯 推荐实现优先级

```
Phase 1 (立即实现) 🔴
├─ Profile.vue
│  ├─ [✅] 显示推荐人状态
│  ├─ [ ] 添加"绑定推荐人"按钮
│  ├─ [ ] 创建绑定模态框
│  ├─ [ ] 实现 bindReferrer() 调用
│  └─ [ ] 错误处理和提示
│
└─ Staking.vue
   ├─ [✅] 检查推荐人状态
   ├─ [ ] 优化：弹出绑定模态框
   └─ [ ] 绑定成功后继续认购

Phase 2 (后续优化) 🟡
├─ App.vue / Router
│  ├─ [ ] 解析 URL 参数 ?ref=0x...
│  ├─ [ ] 保存到 localStorage
│  └─ [ ] 首次连接提示绑定
│
└─ Profile.vue
   ├─ [ ] "复制我的地址"功能
   ├─ [ ] 显示邀请统计
   └─ [ ] 生成邀请二维码

Phase 3 (长期规划) 🟢
├─ 邀请系统
│  ├─ [ ] 邀请排行榜
│  ├─ [ ] 邀请奖励统计
│  └─ [ ] 批量邀请工具
│
└─ 数据分析
   ├─ [ ] 推荐关系图谱
   ├─ [ ] 收益分析
   └─ [ ] 团队业绩展示
```

---

## 💡 关键要点总结

### ❌ 当前问题
1. **合约要求**：必须先绑定推荐人才能质押
2. **前端缺失**：Profile 页面没有绑定功能
3. **用户体验差**：跳转后用户不知道怎么办

### ✅ 解决方案
1. **在 Profile 添加绑定功能**
   - 输入框 + 确认按钮
   - 显示当前状态
   - 友好的错误提示

2. **优化 Staking 流程**
   - 未绑定时弹出模态框
   - 可以直接在认购页面绑定
   - 绑定成功后继续认购

3. **支持 URL 邀请**
   - 通过 ?ref=0x... 传递推荐人
   - 自动填充到绑定表单
   - 保存到本地避免丢失

### 🎯 下一步行动
**立即修改 Profile.vue，添加绑定推荐人功能！**
