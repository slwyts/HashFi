# 团队成员多级显示实现说明

## 📋 问题描述

**场景：**
- A（管理员）→ 推荐 B
- B → 推荐 C

**之前的问题：**
- ❌ A 的团队页面只显示 B（直推）
- ❌ A 看不到 C（二级下线）
- ✅ B 的团队页面能看到 C

**原因：**
合约的 `getDirectReferrals()` 函数只返回**一级直推**，不包括多级下线。

---

## ✅ 解决方案

### 方案选择：前端递归查询

**为什么选择前端实现？**
1. ✅ 不需要修改和重新部署智能合约
2. ✅ 更灵活，可以控制递归深度
3. ✅ 节省链上 gas 成本
4. ✅ 可以添加更多前端展示逻辑

**替代方案（未采用）：**
- ❌ 在合约中添加递归函数：会消耗大量 gas，且难以控制深度

---

## 🔧 实现细节

### 1. 递归查询函数

```typescript
/**
 * 递归获取团队成员（最多10层）
 */
const fetchAllTeamMembers = async (
  userAddress: string, 
  depth = 0, 
  maxDepth = 10
): Promise<any[]> => {
  if (depth >= maxDepth) return [];
  
  // 1. 使用 wagmi 的 readContract 获取直推成员
  const directMembers = await readContract(wagmiConfig, {
    address: CONTRACT_ADDRESS,
    abi,
    functionName: 'getDirectReferrals',
    args: [userAddress as `0x${string}`],
  });
  
  if (!directMembers || directMembers.length === 0) {
    return [];
  }
  
  // 2. 为每个成员添加层级信息
  const formattedMembers = directMembers.map((member: any) => ({
    ...member,
    level: depth + 1, // 记录层级（1=直推，2=二级...）
    referrer: userAddress, // 记录推荐人地址
  }));
  
  // 3. 递归获取每个成员的下级
  const subMembers = await Promise.all(
    directMembers.map(async (member: any) => {
      return await fetchAllTeamMembers(member.memberAddress, depth + 1, maxDepth);
    })
  );
  
  // 4. 合并所有成员
  return [...formattedMembers, ...subMembers.flat()];
};
```

### 2. 自动加载机制

```typescript
// 监听地址变化，自动加载团队成员
watch(address, (newAddress) => {
  if (newAddress) {
    loadAllTeamMembers(); // 触发递归查询
  } else {
    allTeamMembers.value = [];
  }
}, { immediate: true });
```

### 3. 数据结构

**返回的成员数据：**
```typescript
{
  memberAddress: '0x...',
  teamLevel: 2,                    // 合约返回的团队等级（V0-V5）
  totalStakedAmount: 1000000n,     // 个人投资额（bigint）
  teamTotalPerformance: 5000000n,  // 团队业绩（bigint）
  level: 2,                        // 🆕 成员所在层级（1=直推，2=二级...）
  referrer: '0x...'                // 🆕 推荐人地址
}
```

### 4. UI 展示

**层级标签：**
- 直推成员（level=1）：不显示标签
- 二级及以上（level>=2）：显示 "2级"、"3级" 等标签

```vue
<span v-if="member.memberLevel && member.memberLevel > 1" 
      class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">
  {{ member.memberLevel }}级
</span>
```

**加载状态：**
- 查询过程中显示加载动画
- 使用 `isLoadingTeam` 状态控制

---

## 📊 性能优化

### 1. 递归深度限制

- 默认最大深度：**10 层**
- 可防止无限递归和过多的 RPC 请求

### 2. 并行查询

```typescript
// 使用 Promise.all 并行查询所有直推成员的下级
const subMembers = await Promise.all(
  directMembers.map(async (member: any) => {
    return await fetchAllTeamMembers(member.memberAddress, depth + 1, maxDepth);
  })
);
```

### 3. 错误处理

- 每层递归都有 try-catch
- 查询失败不影响其他分支
- 控制台输出详细日志

---

## 🧪 测试场景

### 场景 1：三级团队结构
```
A（管理员）
└── B（V2，投资 1000 USDT）
    └── C（V1，投资 500 USDT）
```

**预期结果：**
- A 的团队页面显示：
  - B（无层级标签）
  - C（显示 "2级" 标签）
- 团队总人数：2人

### 场景 2：复杂树形结构
```
A
├── B（V3）
│   ├── D（V1）
│   └── E（V2）
└── C（V2）
    └── F（V1）
```

**预期结果：**
- A 的团队页面显示：
  - B（无标签）
  - C（无标签）
  - D（2级）
  - E（2级）
  - F（2级）
- 团队总人数：5人

### 场景 3：深层级结构（10层）
```
A → B → C → D → E → F → G → H → I → J → K
```

**预期结果：**
- A 看到 B-J（1-9级）
- K（10级）不显示（超过最大深度）

---

## 🔍 调试日志

### 控制台输出示例

```
✅ 加载团队成员成功: 5 人
✅ 处理团队成员数据: 5 人
获取团队成员失败 (层级 10): Error: Maximum depth reached
```

### 查看数据结构

```javascript
// 在浏览器控制台执行
console.log('所有团队成员:', allTeamMembers.value);
console.log('格式化后的成员:', teamMembers.value);
```

---

## 📝 后续优化建议

### 1. 分页显示
- 当团队成员超过 100 人时，添加分页功能
- 避免一次性渲染过多 DOM 元素

### 2. 缓存机制
- 将递归查询结果缓存到 localStorage
- 设置 TTL（例如 5 分钟）
- 减少重复的 RPC 请求

### 3. 树形可视化
- 添加团队树形图组件
- 使用 D3.js 或 ECharts 展示层级关系
- 支持节点展开/折叠

### 4. 搜索和筛选
- 按地址搜索团队成员
- 按层级筛选（例如只看二级下线）
- 按业绩排序

---

## ⚠️ 注意事项

### 1. RPC 请求限制
- 递归查询会发起多个 RPC 请求
- 团队成员越多，请求越多
- 建议：在公共 RPC 节点限制下使用，或使用私有节点

### 2. 加载时间
- 首次加载可能需要几秒钟
- 深度越深，时间越长
- 建议：显示加载进度条

### 3. 数据一致性
- 递归查询期间，链上数据可能变化
- 建议：添加刷新按钮，允许用户手动更新

---

## 📚 相关文件

| 文件 | 修改内容 |
|------|---------|
| `src/views/Team.vue` | 添加递归查询逻辑、更新 UI |
| `contract/HashFi.sol` | 无需修改 |
| `src/locales/*.json` | 使用现有的 `common.loading` |

---

## ✅ 完成清单

- [x] 实现递归查询函数 `fetchAllTeamMembers()`
- [x] 添加自动加载机制（watch 地址变化）
- [x] 更新 `TeamMember` 接口，添加 `memberLevel` 字段
- [x] 修改 `totalMembers` 计算逻辑（显示所有层级）
- [x] 修改 `teamMembers` 计算逻辑（使用递归数据）
- [x] 添加层级标签 UI（2级、3级...）
- [x] 添加加载状态 UI
- [x] 添加错误处理和日志
- [x] 编写技术文档

---

## 🎯 预期效果

修改后，团队页面将：
1. ✅ 显示所有层级的团队成员（最多10层）
2. ✅ 显示每个成员的层级标签（2级、3级...）
3. ✅ 显示正确的团队总人数
4. ✅ 支持深层级团队结构
5. ✅ 提供良好的加载状态反馈

---

**测试方法：**
1. 连接钱包到 HashFi DApp
2. 进入"团队"页面
3. 观察团队成员列表和层级标签
4. 检查控制台日志确认递归查询
