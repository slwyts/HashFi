# 烧伤机制测试说明

## 📊 场景分析

### 场景：A(管理员) → B(白银) → C(黄金1000U)

#### 1. B投资白银（假设500U）
- **推荐人**：A（管理员）
- **A的级别**：钻石(4) - 管理员默认最高级别
- **B的投资**：500U（白银级别2）
- **烧伤判断**：钻石 >= 白银 → ❌ 不烧伤
- **A获得奖励**：500 × 5% = **25U** ✅

#### 2. C投资黄金1000U
- **推荐人**：B
- **B的级别**：白银(2)，最高投资499U
- **C的投资**：1000U（黄金级别3）
- **烧伤判断**：白银(2) < 黄金(3) → ✅ 发生烧伤

##### B获得直推奖（1代，5%）
- **完整奖励**：1000U × 5% = 50U
- **可领取金额**：999U（白银上限）
- **实际奖励**：999U × 5% = **49.95U**
- **烧伤金额**：50U - 49.95U = **0.05U**
- **烧伤事件**：`RewardBurned(B, C, 50U, 49.95U, 0.05U)`

##### A获得间推奖（2代，3%）
- **完整奖励**：1000U × 3% = 30U
- **A的级别**：钻石(4)
- **烧伤判断**：钻石无烧伤
- **实际奖励**：1000U × 3% = **30U** ✅

---

## 🔍 问题解答

### 问题一：没有烧伤？
**答**：有烧伤！但烧伤金额很小（0.05U）。前端需要监听 `RewardBurned` 事件来显示烧伤信息。

```solidity
event RewardBurned(
    address indexed referrer,    // B的地址
    address indexed investor,     // C的地址
    uint256 fullRewardUsdt,      // 50U
    uint256 actualRewardUsdt,    // 49.95U
    uint256 burnedUsdt           // 0.05U
);
```

### 问题二：只显示49.95U？
**答**：这是**正确的**！因为：
1. B是白银级别（最高投资999U）
2. C投资1000U黄金
3. 白银 < 黄金 → 烧伤
4. B最多拿白银上限999U的5% = **49.95U**

### 问题三：100天释放金额不对？
**答**：已修复！现在按天释放：
- B获得49.95U直推奖
- 转换为HAF（假设HAF价格=1U）= 49.95 HAF
- **每天释放**：49.95 / 100 = **0.4995 HAF/天**
- **100天后**：累计释放49.95 HAF ✅

---

## 📋 烧伤规则总结

### 规则1：同级别推荐
- 青铜推青铜 → ❌ 不烧伤
- 白银推白银 → ❌ 不烧伤
- 黄金推黄金 → ❌ 不烧伤
- 钻石推钻石 → ❌ 不烧伤

### 规则2：跨级别推荐
- 青铜推白银/黄金/钻石 → ✅ 烧伤到499U
- 白银推黄金/钻石 → ✅ 烧伤到999U
- 黄金推钻石 → ✅ 烧伤到2999U

### 规则3：钻石无烧伤
- 钻石推任何级别 → ❌ 永远不烧伤

### 规则4：管理员无烧伤
- 管理员(owner)视为钻石级别 → ❌ 永远不烧伤

---

## 🧪 测试案例

### 案例1：青铜推黄金
```
A(青铜100U) → B(黄金1000U)
- 完整奖励：1000 × 5% = 50U
- 实际奖励：499 × 5% = 24.95U
- 烧伤：25.05U
```

### 案例2：白银推钻石
```
A(白银500U) → B(钻石3000U)
- 完整奖励：3000 × 5% = 150U
- 实际奖励：999 × 5% = 49.95U
- 烧伤：100.05U
```

### 案例3：黄金推钻石
```
A(黄金1000U) → B(钻石3000U)
- 完整奖励：3000 × 5% = 150U
- 实际奖励：2999 × 5% = 149.95U
- 烧伤：0.05U
```

### 案例4：钻石推任何级别
```
A(钻石3000U) → B(任意金额)
- 永远不烧伤，全额获得奖励
```

---

## 🎯 前端显示建议

### 1. 监听烧伤事件
```javascript
contract.on("RewardBurned", (referrer, investor, fullReward, actualReward, burned) => {
    console.log(`烧伤发生！`);
    console.log(`推荐人: ${referrer}`);
    console.log(`投资人: ${investor}`);
    console.log(`完整奖励: ${fullReward}U`);
    console.log(`实际奖励: ${actualReward}U`);
    console.log(`烧伤金额: ${burned}U`);
});
```

### 2. 显示烧伤状态
```javascript
// 在收益记录中显示
{
    type: "直推奖",
    investor: "0x...",
    fullReward: "50.00 USDT",
    actualReward: "49.95 USDT",
    burned: "0.05 USDT",
    isBurned: true  // 标记为烧伤
}
```

### 3. 烧伤提示
```
⚠️ 由于级别限制，您的奖励从 50.00 USDT 烧伤至 49.95 USDT
💡 提示：升级到黄金或钻石级别可避免烧伤
```

---

## ✅ 修复总结

1. ✅ 管理员级别判断 - 管理员视为钻石级别
2. ✅ 动态奖100天释放 - 改为按天释放（总额/100）
3. ✅ 烧伤机制 - 烧伤奖励而非代币
4. ✅ 烧伤事件 - 添加详细的 `RewardBurned` 事件

---

## 🔗 相关代码位置

- **烧伤判断**：`_calculateBurnableAmount()` - 第1054行
- **直推奖烧伤**：`_updateAncestorsPerformanceAndRewards()` - 第557-595行
- **分享奖烧伤**：`_distributeShareRewards()` - 第607-659行
- **动态奖释放**：`_calculatePendingDynamic()` - 第857-887行
- **管理员级别**：`_getUserHighestLevel()` - 第1043-1053行
