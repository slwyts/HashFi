# ğŸ”§ åˆ›ä¸–èŠ‚ç‚¹æŒ‰é’®"æŒ‰ä¸äº†"é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
> åˆ›ä¸–èŠ‚ç‚¹ä¸ºå•¥é‚£ä¸ªæŒ‰é’®æ˜¯æ­»çš„æŒ‰ä¸äº†

**ç—‡çŠ¶ï¼š**
- "ç”³è¯·æˆä¸ºåˆ›ä¸–èŠ‚ç‚¹"æŒ‰é’®æ˜¾ç¤ºä¸ºç°è‰²
- æŒ‰é’®æç¤º"å¿…é¡»å…ˆè¿›è¡Œè´¨æŠ¼"
- å³ä½¿ç”¨æˆ·å·²ç»è´¨æŠ¼ï¼ŒæŒ‰é’®ä»ç„¶æ— æ³•ç‚¹å‡»

---

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜1: é”™è¯¯çš„æ•°æ®è®¿é—®æ–¹å¼ â­ **æ ¸å¿ƒé—®é¢˜**

å‰ç«¯ä½¿ç”¨**æ•°ç»„ç´¢å¼•**è®¿é—® Viem è¿”å›çš„å¯¹è±¡ï¼š

```typescript
// âŒ é”™è¯¯ä»£ç 
const hasStaked = computed(() => {
  if (!userData.value) return false;
  return (userData.value as any)[1] > 0n; // totalStakedAmount
});

const userIsNode = computed(() => {
  if (!userData.value) return false;
  return (userData.value as any)[14]; // isGenesisNode
});
```

**ä½†æ˜¯ Viem å°† Solidity struct è½¬æ¢ä¸º JavaScript å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š**

```javascript
// Viem å®é™…è¿”å›çš„æ ¼å¼
userData.value = {
  referrer: '0x...',
  teamLevel: 0,
  totalStakedAmount: 30000000000000000000000000n, // âœ… è¿™é‡Œæœ‰å€¼
  teamTotalPerformance: 0n,
  directReferrals: [],
  orderIds: [0n],
  isGenesisNode: false,
  genesisDividendsWithdrawn: 0n,
  // ...
}

// é”™è¯¯çš„è®¿é—®æ–¹å¼
userData.value[1]  // undefined âŒ
userData.value[14] // undefined âŒ

// æ­£ç¡®çš„è®¿é—®æ–¹å¼
userData.value.totalStakedAmount  // 30000000000000000000000000n âœ…
userData.value.isGenesisNode      // false âœ…
```

### é—®é¢˜2: ä¸å­˜åœ¨çš„åˆçº¦å‡½æ•°

å‰ç«¯å°è¯•è°ƒç”¨ä¸å­˜åœ¨çš„ `genesisNodeUsers` å‡½æ•°ï¼š

```typescript
// âŒ åˆçº¦ä¸­æ²¡æœ‰è¿™ä¸ªå‡½æ•°
const { data: genesisUserData } = useReadContract({
  functionName: 'genesisNodeUsers', // âŒ ä¸å­˜åœ¨ï¼
});
```

**åº”è¯¥ä» `users` mapping ä¸­è¯»å– `genesisDividendsWithdrawn` å­—æ®µã€‚**

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1: ä½¿ç”¨å¯¹è±¡å­—æ®µåè®¿é—®

```typescript
// âœ… æ­£ç¡®ä»£ç 
// ç”¨æˆ·æ˜¯å¦å·²è´¨æŠ¼
const hasStaked = computed(() => {
  if (!userData.value) return false;
  const totalStaked = (userData.value as any).totalStakedAmount; // âœ… ä½¿ç”¨å­—æ®µå
  return totalStaked && totalStaked > 0n;
});

// ç”¨æˆ·æ˜¯å¦æ˜¯åˆ›ä¸–èŠ‚ç‚¹
const userIsNode = computed(() => {
  if (!userData.value) return false;
  return (userData.value as any).isGenesisNode; // âœ… ä½¿ç”¨å­—æ®µå
});
```

### ä¿®å¤2: æ­£ç¡®è¯»å–å·²æå–åˆ†çº¢

```typescript
// âœ… æ­£ç¡®ä»£ç 
// å·²æå–åˆ†çº¢ï¼ˆä» users.genesisDividendsWithdrawn è¯»å–ï¼‰
const withdrawnDividends = computed(() => {
  if (!userData.value) return '0.00';
  const withdrawn = (userData.value as any).genesisDividendsWithdrawn; // âœ… ä½¿ç”¨å­—æ®µå
  if (!withdrawn) return '0.00';
  return parseFloat(formatUnits(withdrawn as bigint, 18)).toFixed(2);
});
```

### ä¿®å¤3: åˆ é™¤ä¸å­˜åœ¨çš„å‡½æ•°è°ƒç”¨

```diff
- // ========== 4. è·å–åˆ›ä¸–èŠ‚ç‚¹ç”¨æˆ·ä¿¡æ¯ ==========
- const { data: genesisUserData } = useReadContract({
-   functionName: 'genesisNodeUsers', // âŒ ä¸å­˜åœ¨
- });
-
- const withdrawnDividends = computed(() => {
-   if (!genesisUserData.value) return '0.00';
-   return parseFloat(formatUnits((genesisUserData.value as any)[0] as bigint, 18)).toFixed(2);
- });

+ // ========== 4. å·²æå–åˆ†çº¢ï¼ˆä» users è¯»å–ï¼‰==========
+ const withdrawnDividends = computed(() => {
+   if (!userData.value) return '0.00';
+   const withdrawn = (userData.value as any).genesisDividendsWithdrawn;
+   if (!withdrawn) return '0.00';
+   return parseFloat(formatUnits(withdrawn as bigint, 18)).toFixed(2);
+ });
```

---

## ğŸ“Š User ç»“æ„ä½“å­—æ®µæ˜ å°„

### Solidity åˆçº¦å®šä¹‰

```solidity
struct User {
    address referrer;                  // 0
    uint8 teamLevel;                   // 1
    uint256 totalStakedAmount;         // 2 âœ… è´¨æŠ¼é‡‘é¢
    uint256 teamTotalPerformance;      // 3
    address[] directReferrals;         // 4 (æ•°ç»„ï¼Œä¸åœ¨ mapping è¿”å›ä¸­)
    uint256[] orderIds;                // 5 (æ•°ç»„ï¼Œä¸åœ¨ mapping è¿”å›ä¸­)
    bool isGenesisNode;                // 6 âœ… æ˜¯å¦æ˜¯åˆ›ä¸–èŠ‚ç‚¹
    uint256 genesisDividendsWithdrawn; // 7 âœ… å·²æå–åˆ†çº¢
    uint256 dynamicRewardTotal;        // 8
    uint256 dynamicRewardReleased;     // 9
    uint256 dynamicRewardStartTime;    // 10
    uint256 dynamicRewardClaimed;      // 11
    uint256 totalStaticOutput;         // 12
    RewardRecord[] rewardRecords;      // 13 (æ•°ç»„ï¼Œä¸åœ¨ mapping è¿”å›ä¸­)
}
```

### JavaScript å¯¹è±¡è®¿é—®

```typescript
// âœ… æ­£ç¡®æ–¹å¼
userData.value.referrer
userData.value.teamLevel
userData.value.totalStakedAmount         // â­ ç”¨äºåˆ¤æ–­æ˜¯å¦è´¨æŠ¼
userData.value.teamTotalPerformance
userData.value.isGenesisNode             // â­ ç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯èŠ‚ç‚¹
userData.value.genesisDividendsWithdrawn // â­ å·²æå–åˆ†çº¢
userData.value.dynamicRewardTotal
// ...

// âŒ é”™è¯¯æ–¹å¼
userData.value[0]
userData.value[1]
userData.value[2]
// ...
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

```typescript
// hasStaked é€»è¾‘
const totalStaked = userData.value[1]; // undefined âŒ
return totalStaked > 0n; // æ°¸è¿œè¿”å› false

// æŒ‰é’®çŠ¶æ€
canApply = false (å› ä¸º hasStaked = false)
buttonText = "å¿…é¡»å…ˆè¿›è¡Œè´¨æŠ¼"
æŒ‰é’®ç¦ç”¨ âŒ
```

### ä¿®å¤å

```typescript
// hasStaked é€»è¾‘
const totalStaked = userData.value.totalStakedAmount; // 30000000000000000000000000n âœ…
return totalStaked > 0n; // è¿”å› true

// æŒ‰é’®çŠ¶æ€
canApply = true (å¦‚æœå…¶ä»–æ¡ä»¶æ»¡è¶³)
buttonText = "æˆæƒ USDT" æˆ– "ç«‹å³ç”³è¯·"
æŒ‰é’®å¯ç‚¹å‡» âœ…
```

---

## ğŸ“ æŒ‰é’®çŠ¶æ€é€»è¾‘

### æŒ‰é’®å¯ç”¨æ¡ä»¶

```typescript
const canApply = computed(() => {
  if (!address.value) return false;              // 1. å¿…é¡»è¿æ¥é’±åŒ…
  if (!hasStaked.value) return false;            // 2. å¿…é¡»å·²è´¨æŠ¼ â­ ä¿®å¤äº†è¿™ä¸ª
  if (userIsNode.value) return false;            // 3. ä¸èƒ½å·²ç»æ˜¯èŠ‚ç‚¹
  if (isPendingApproval.value) return false;     // 4. ä¸èƒ½æœ‰å¾…å®¡æ ¸ç”³è¯·
  if (parseFloat(usdtBalanceDisplay.value) < 
      parseFloat(nodeCostDisplay.value)) {
    return false;                                 // 5. USDT ä½™é¢å¿…é¡»è¶³å¤Ÿ
  }
  return true;
});
```

### æŒ‰é’®æ–‡æœ¬æ˜¾ç¤º

```typescript
const buttonText = computed(() => {
  if (!address.value) return 'è¿æ¥é’±åŒ…';
  if (!hasStaked.value) return 'å¿…é¡»å…ˆè¿›è¡Œè´¨æŠ¼';  // â­ ä¹‹å‰ä¸€ç›´æ˜¾ç¤ºè¿™ä¸ª
  if (userIsNode.value) return 'å·²æ˜¯åˆ›ä¸–èŠ‚ç‚¹';
  if (isPendingApproval.value) return 'å®¡æ ¸ä¸­';
  if (ä½™é¢ä¸è¶³) return 'ä½™é¢ä¸è¶³';
  if (needsApproval.value) return 'æˆæƒ USDT';    // âœ… ä¿®å¤åå¯ä»¥åˆ°è¿™é‡Œ
  if (isApproving.value) return 'æˆæƒä¸­...';
  if (isApplying.value) return 'ç”³è¯·ä¸­...';
  return 'ç«‹å³ç”³è¯·';                              // âœ… æœ€ç»ˆçŠ¶æ€
});
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1: æœªè´¨æŠ¼ç”¨æˆ·
- âœ… æŒ‰é’®æ˜¾ç¤º"å¿…é¡»å…ˆè¿›è¡Œè´¨æŠ¼"
- âœ… æŒ‰é’®ç¦ç”¨ï¼ˆç¬¦åˆé¢„æœŸï¼‰

### åœºæ™¯2: å·²è´¨æŠ¼ç”¨æˆ·ï¼ˆä¿®å¤åï¼‰
- âœ… `hasStaked.value = true`
- âœ… æŒ‰é’®æ˜¾ç¤º"æˆæƒ USDT"
- âœ… æŒ‰é’®å¯ç‚¹å‡»

### åœºæ™¯3: å·²æˆæƒç”¨æˆ·
- âœ… æŒ‰é’®æ˜¾ç¤º"ç«‹å³ç”³è¯·"
- âœ… ç‚¹å‡»åå‘èµ·ç”³è¯·äº¤æ˜“

### åœºæ™¯4: å·²æ˜¯åˆ›ä¸–èŠ‚ç‚¹
- âœ… æ˜¾ç¤ºèŠ‚ç‚¹ä¸­å¿ƒé¡µé¢ï¼ˆä¸æ˜¾ç¤ºç”³è¯·æŒ‰é’®ï¼‰

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

- âœ… `src/views/GenesisNode.vue`
  - ä¿®å¤ `hasStaked` è®¡ç®—ï¼ˆä½¿ç”¨ `totalStakedAmount` å­—æ®µï¼‰
  - ä¿®å¤ `userIsNode` è®¡ç®—ï¼ˆä½¿ç”¨ `isGenesisNode` å­—æ®µï¼‰
  - ä¿®å¤ `withdrawnDividends` è®¡ç®—ï¼ˆä½¿ç”¨ `genesisDividendsWithdrawn` å­—æ®µï¼‰
  - åˆ é™¤ä¸å­˜åœ¨çš„ `genesisNodeUsers` å‡½æ•°è°ƒç”¨

---

## ğŸ¨ UI æµç¨‹

### ç”³è¯·æµç¨‹
```
1. ç”¨æˆ·å·²è´¨æŠ¼ (hasStaked = true) âœ…
   â†“
2. ç‚¹å‡»"æˆæƒ USDT"æŒ‰é’®
   â†“
3. æˆæƒæˆåŠŸåï¼ŒæŒ‰é’®å˜ä¸º"ç«‹å³ç”³è¯·"
   â†“
4. ç‚¹å‡»"ç«‹å³ç”³è¯·"
   â†“
5. äº¤æ˜“æˆåŠŸï¼Œè¿›å…¥"å¾…å®¡æ ¸"çŠ¶æ€
   â†“
6. ç®¡ç†å‘˜æ‰¹å‡†åï¼Œæˆä¸ºåˆ›ä¸–èŠ‚ç‚¹
```

---

## âš ï¸ é‡è¦æé†’

### Viem æ•°æ®ç»“æ„è½¬æ¢è§„åˆ™

**Solidity â†’ JavaScript æ˜ å°„ï¼š**

| Solidity ç±»å‹ | JavaScript ç±»å‹ | è®¿é—®æ–¹å¼ |
|--------------|----------------|---------|
| `struct { uint256 x; }` | `{ x: bigint }` | `obj.x` âœ… |
| `struct` (é€šè¿‡ mapping) | å¯¹è±¡ï¼ˆä¸åŒ…å«æ•°ç»„å­—æ®µï¼‰ | `obj.fieldName` âœ… |
| `mapping(address => Type)` | ä¸ç›´æ¥è¿”å› | éœ€è¦è°ƒç”¨ getter |
| `Type[] public array` | æ•°ç»„ | `arr[index]` |

**å…³é”®ç‚¹ï¼š**
1. âœ… **Struct å­—æ®µç”¨å¯¹è±¡å±æ€§è®¿é—®**ï¼š`userData.totalStakedAmount`
2. âŒ **ä¸è¦ç”¨æ•°ç»„ç´¢å¼•**ï¼š`userData[2]`
3. âš ï¸ **Mapping è¿”å›çš„ struct ä¸åŒ…å«æ•°ç»„å­—æ®µ**ï¼ˆ`directReferrals`, `orderIds`, `rewardRecords`ï¼‰

---

## âœ… ä¿®å¤å®Œæˆ

ç°åœ¨æŒ‰é’®åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œäº†ï¼

**ä¿®å¤æ—¶é—´:** 2025-10-09  
**ä¿®å¤æ–‡ä»¶:** `src/views/GenesisNode.vue`  
**å…³é”®è¡Œæ•°:** 
- `hasStaked`: ~177 è¡Œ
- `userIsNode`: ~171 è¡Œ
- `withdrawnDividends`: ~200 è¡Œ

---

## ğŸš€ éªŒè¯æ­¥éª¤

1. **æ£€æŸ¥ç”¨æˆ·è´¨æŠ¼çŠ¶æ€**
   - æ‰“å¼€æ§åˆ¶å°
   - è¾“å…¥ï¼š`console.log('Has Staked:', userData.value?.totalStakedAmount)`
   - åº”è¯¥çœ‹åˆ°ä¸€ä¸ªå¤§æ•°å­—ï¼ˆå¦‚æœå·²è´¨æŠ¼ï¼‰

2. **æ£€æŸ¥æŒ‰é’®çŠ¶æ€**
   - å¦‚æœå·²è´¨æŠ¼ï¼ŒæŒ‰é’®åº”è¯¥æ˜¾ç¤º"æˆæƒ USDT"æˆ–"ç«‹å³ç”³è¯·"
   - æŒ‰é’®åº”è¯¥æ˜¯è“è‰²ï¼ˆå¯ç‚¹å‡»ï¼‰

3. **æµ‹è¯•ç”³è¯·æµç¨‹**
   - ç‚¹å‡»æŒ‰é’®æˆæƒ USDT
   - æˆæƒåç‚¹å‡»"ç«‹å³ç”³è¯·"
   - ç­‰å¾…äº¤æ˜“ç¡®è®¤
   - åº”è¯¥çœ‹åˆ°"å¾…å®¡æ ¸"é¡µé¢

**è¯·åˆ·æ–°é¡µé¢æµ‹è¯•ï¼** ğŸ‰
